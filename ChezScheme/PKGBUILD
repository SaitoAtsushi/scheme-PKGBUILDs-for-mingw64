pkgbase=chez
pkgname=("${MINGW_PACKAGE_PREFIX}-chez")
pkgver=10.3.0
pkgrel=1
pkgdesc="A implementation for the Scheme programming language."
arch=('any')
url="https://cisco.github.io/ChezScheme/"
license=('Apache 2.0')
depends=()
makedepends=("${MINGW_PACKAGE_PREFIX}-gcc"
             "${MINGW_PACKAGE_PREFIX}-curl"
             "patch"
             "coreutils"
             "tar"
             "make")
source=("ChezSchme-10.3.0.tar.gz::https://github.com/cisco/ChezScheme/releases/download/v10.3.0/csv10.3.0.tar.gz")
noextract=("ChezSchme-10.3.0.tar.gz")
sha256sums=('d237d9874c6e8b0ccf7758daa8286a6e825528b13ce3b2bca56eb1f73cddbc2c')

prepare() {
  tar xzf ChezSchme-10.3.0.tar.gz --exclude "csug" --exclude "wininstall" --exclude "rpm"
  cd ${srcdir}/csv10.3.0
}

build() {
  cd ${srcdir}/csv10.3.0

  case "${MSYSTEM}" in
    MINGW64)
      machine=ta6nt
    ;;
    MINGW32)
      machine=ti3nt
    ;;
  esac
  
  ./configure -m=${machine} --threads --installprefix=${MINGW_PREFIX} --installlib=${MINGW_PREFIX}/lib/ --temproot=${pkgdir} CFLAGS+=-D'"DEFAULT_HEAP_PATH=\"%x;%x/../../boot/%m;%x/../lib/csv%v/%m\""'
  make
}

package() {
  cd ${srcdir}/csv10.3.0
  install -D -t ${pkgdir}/${MINGW_PREFIX}/lib/csv10.3.0/examples ./examples/*
  install -D -t ${pkgdir}/${MINGW_PREFIX}/lib/csv10.3.0/ta6nt ./boot/ta6nt/*
  install -D -t ${pkgdir}/${MINGW_PREFIX}/bin ./ta6nt/bin/ta6nt/scheme.exe
}
